<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeadCallr AI App</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-gradient: radial-gradient(120% 120% at 0% 0%, rgba(13, 79, 124, 0.78) 0%, rgba(16, 42, 67, 0.95) 45%, #091524 100%);
            --card-bg: rgba(255, 255, 255, 0.92);
            --card-border: rgba(255, 255, 255, 0.16);
            --primary: #0d7bff;
            --primary-dark: #0b5ed7;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --text-primary: #102a43;
            --text-secondary: #516177;
            --blur: rgba(255, 255, 255, 0.65);
            --shadow: 0 24px 60px rgba(7, 14, 30, 0.25);
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            position: relative;
            overflow-x: hidden;
        }

        .background-glow {
            position: fixed;
            inset: 0;
            pointer-events: none;
            background:
                radial-gradient(60% 60% at 10% 10%, rgba(13, 123, 255, 0.18) 0%, rgba(9, 21, 36, 0) 60%),
                radial-gradient(40% 40% at 90% 10%, rgba(0, 255, 224, 0.15) 0%, rgba(9, 21, 36, 0) 55%);
            z-index: 0;
        }

        .app-shell {
            position: relative;
            z-index: 1;
            max-width: 1440px;
            margin: 0 auto;
            padding: 40px 32px 88px;
        }

        .glass-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 22px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(12px);
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 18px;
            padding: 22px 30px;
            margin-bottom: 32px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .brand img {
            height: 48px;
        }

        .brand .tagline {
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: rgba(16, 42, 67, 0.65);
        }

        .logout-button {
            background: linear-gradient(135deg, #dc3545, #b71c2b);
            color: #ffffff;
            border: none;
            border-radius: 10px;
            padding: 10px 22px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 12px 30px rgba(220, 53, 69, 0.35);
            transition: transform 0.18s ease, box-shadow 0.18s ease, opacity 0.18s ease;
            margin: 0;
        }

        .logout-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 14px 34px rgba(220, 53, 69, 0.42);
        }

        .logout-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            box-shadow: none;
        }

        .intro-card {
            padding: 34px 38px;
            margin-bottom: 32px;
        }

        .intro-card h1 {
            margin: 0 0 12px;
            font-size: 34px;
            color: #0f1f38;
        }

        .intro-card p {
            margin: 0;
            font-size: 16px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .intro-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 18px;
        }

        .intro-meta img {
            height: 34px;
        }

        .intro-meta span {
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: rgba(16, 42, 67, 0.65);
        }

        .dashboard-layout {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 28px;
            align-items: start;
            transition: grid-template-columns 0.3s ease;
        }

        .dashboard-layout.sidebar-collapsed {
            grid-template-columns: 80px 1fr;
        }

        /* Sidebar Styles */
        .sidebar {
            position: sticky;
            top: 20px;
            height: fit-content;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            background: transparent;
            transition: width 0.3s ease;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(16, 42, 67, 0.14);
            border-radius: 14px;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .sidebar-toggle {
            background: rgba(0, 124, 186, 0.1);
            border: 1px solid rgba(0, 124, 186, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 18px;
            color: #007cba;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .sidebar-toggle:hover {
            background: rgba(0, 124, 186, 0.2);
            transform: scale(1.05);
        }

        .sidebar-title {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #1a2f4d;
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.3s ease;
        }

        .sidebar-content {
            display: flex;
            flex-direction: column;
            gap: 28px;
            transition: opacity 0.3s ease;
        }

        /* Collapsed Sidebar Styles */
        .sidebar.sidebar-collapsed .sidebar-header {
            flex-direction: column;
            padding: 12px 8px;
            align-items: center;
        }

        .sidebar.sidebar-collapsed .sidebar-title {
            display: none;
        }

        .sidebar.sidebar-collapsed .sidebar-content {
            opacity: 0;
            pointer-events: none;
            height: 0;
            overflow: hidden;
        }

        .sidebar.sidebar-collapsed .time-settings,
        .sidebar.sidebar-collapsed .upload-container,
        .sidebar.sidebar-collapsed #result {
            display: none;
        }

        /* Icon-only view for collapsed sidebar - show icons as tooltips on hover */
        .sidebar.sidebar-collapsed .sidebar-header {
            cursor: pointer;
        }

        .sidebar.sidebar-collapsed .sidebar-toggle {
            margin-bottom: 12px;
        }

        /* Tooltip for collapsed sidebar */
        .sidebar.sidebar-collapsed .sidebar-header[title]::after {
            content: attr(title);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 12px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 1000;
        }

        .sidebar.sidebar-collapsed .sidebar-header:hover::after {
            opacity: 1;
        }

        /* Section subtitle is already handled above */

        .right-column {
            display: flex;
            flex-direction: column;
            gap: 28px;
            min-width: 0; /* Allows flex item to shrink below content size */
        }

        .main-content {
            width: 100%;
        }

        @media (max-width: 1120px) {
            .dashboard-layout {
                grid-template-columns: 1fr !important;
            }
            
            .sidebar {
                position: relative;
                top: 0;
                max-height: none;
            }

            .sidebar.sidebar-collapsed {
                display: none;
            }
        }

        .panel-card {
            padding: 26px 30px;
        }

        .section-title {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-start;
            margin-bottom: 20px;
            gap: 4px;
        }
        
        /* Dashboard section title keeps horizontal layout */
        .status-container .section-title {
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }
        
        /* Sidebar section titles use vertical layout */
        .sidebar .section-title {
            flex-direction: column;
            align-items: flex-start;
        }

        .section-title h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #102a43;
        }

        .section-title span:not(.section-subtitle) {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .section-title .section-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            display: block;
            margin-top: 4px;
            width: 100%;
        }
        
        /* Hide subtitle when sidebar is collapsed */
        .sidebar.sidebar-collapsed .section-subtitle {
            display: none !important;
        }

        .summary-short {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .summary-expanded {
            max-width: 400px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .see-more-btn {
            color: #007cba;
            cursor: pointer;
            text-decoration: underline;
            font-size: 12px;
        }
        .recording-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .recording-btn:hover {
            background-color: #218838;
        }
        .edit-btn {
            color: #007cba;
            cursor: pointer;
            margin-left: 5px;
            font-size: 12px;
        }
        .edit-input {
            border: 1px solid #007cba;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
        }

        .outcome-interested { color: #28a745; font-weight: bold; }
        .outcome-voicemail { color: #ffc107; font-weight: bold; }
        .outcome-listings { color: #17a2b8; font-weight: bold; }
        .outcome-callback { color: #6f42c1; font-weight: bold; }
        .outcome-not-interested { color: #dc3545; font-weight: bold; }
        .outcome-other { color: #6c757d; font-weight: bold; }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #a7c5e3;
            background: #eef4fb;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #0d4f7c;
            font-weight: 600;
            transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
            margin: 0;
        }
        .filter-btn:hover {
            background: #dbe9f9;
            border-color: #7fb0e0;
        }
        .filter-btn.active {
            background: #007cba;
            color: white;
            border-color: #007cba;
            box-shadow: 0 2px 6px rgba(0, 124, 186, 0.24);
        }
        .analytics-btn {
            margin-left: 10px;
            background: #17a2b8;
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }
        .analytics-btn:hover {
            background: #117a8b;
        }
        .analytics-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.35);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease;
            z-index: 998;
        }
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
        }
        .form-row label {
            font-weight: 600;
            color: #0d4f7c;
        }
        .form-row select {
            padding: 8px;
            border: 1px solid #c7d9ef;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-row select:disabled {
            background: #f0f4f9;
            color: #6c7a8e;
        }
        .helper-text {
            font-size: 12px;
            color: #6c7a8e;
        }
        .helper-text.error {
            color: #c0392b;
        }
        .analytics-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .analytics-panel {
            position: fixed;
            top: 0;
            right: -420px;
            width: 420px;
            height: 100%;
            background: #ffffff;
            box-shadow: -4px 0 12px rgba(0,0,0,0.15);
            z-index: 999;
            display: flex;
            flex-direction: column;
            transition: right 0.25s ease;
        }
        .analytics-panel.open {
            right: 0;
        }
        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            border-bottom: 1px solid #e5e9ef;
        }
        .analytics-header h3 {
            margin: 0;
            font-size: 18px;
            color: #0d4f7c;
        }
        .analytics-close {
            background: transparent;
            color: #7a8899;
            font-size: 22px;
            border: none;
            cursor: pointer;
        }
        .analytics-close:hover {
            color: #2c3e50;
        }
        .analytics-content {
            padding: 18px 24px;
            overflow-y: auto;
            flex: 1;
        }
        .analytics-summary {
            display: grid;
            grid-template-columns: repeat(2, minmax(0,1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        .analytics-card {
            background: #f5f8fb;
            border: 1px solid #dde6f2;
            border-radius: 10px;
            padding: 12px 14px;
        }
        .analytics-card h4 {
            margin: 0 0 4px 0;
            font-size: 13px;
            text-transform: uppercase;
            color: #6c7a8e;
            letter-spacing: 0.5px;
        }
        .analytics-card .value {
            font-size: 20px;
            font-weight: 700;
            color: #0d4f7c;
        }
        .analytics-card .sub {
            font-size: 12px;
            color: #7a8899;
        }
        .analytics-chart {
            margin-bottom: 28px;
        }
        .analytics-empty {
            text-align: center;
            padding: 40px 10px;
            color: #6c7a8e;
            background: #f8fbff;
            border: 1px solid #dbe7f5;
            border-radius: 10px;
        }
        .upload-container,
        .time-settings {
            margin: 0 0 28px;
        }
        .time-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .time-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .time-group label {
            font-weight: 600;
            color: #1a2f4d;
        }
        select {
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(16, 42, 67, 0.18);
            font-size: 14px;
            background: rgba(255, 255, 255, 0.92);
            box-shadow: inset 0 1px 3px rgba(16, 42, 67, 0.06);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(13, 123, 255, 0.15);
        }
        button {
            background: linear-gradient(135deg, var(--primary), #00b4ff);
            color: white;
            padding: 12px 26px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            margin: 6px 6px 0 0;
            box-shadow: 0 12px 30px rgba(13, 123, 255, 0.35);
            transition: transform 0.18s ease, box-shadow 0.18s ease, opacity 0.18s ease;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 16px 36px rgba(13, 123, 255, 0.42);
        }
        button:disabled {
            background: #b5c7dd;
            cursor: not-allowed;
            box-shadow: none;
        }
        .submit-actions {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px 14px;
            margin-top: 12px;
        }
        .file-input {
            margin: 20px 0 10px;
            padding: 18px;
            border: 1px dashed rgba(16, 42, 67, 0.24);
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.75);
            text-align: center;
        }
        .file-input input[type="file"] {
            border: none;
            width: 100%;
            max-width: none;
        }
        .file-hint {
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .cancel-btn {
            background: linear-gradient(135deg, #ff4d4d, #b71c2b);
            box-shadow: 0 12px 28px rgba(183, 28, 43, 0.35);
        }
        .cancel-btn:hover {
            box-shadow: 0 14px 34px rgba(183, 28, 43, 0.42);
        }
        #result {
            margin: 0;
            padding: 0;
            border-radius: 0;
        }
        .result-banner {
            margin-top: 22px;
            padding: 18px 22px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(13, 123, 255, 0.18);
            display: none;
        }
        .result-banner:not(:empty) {
            display: block;
        }
        .success {
            background: rgba(40, 167, 69, 0.12);
            border: 1px solid rgba(40, 167, 69, 0.28);
            color: #146c2e;
        }
        .error {
            background: rgba(220, 53, 69, 0.12);
            border: 1px solid rgba(220, 53, 69, 0.28);
            color: #9c1f2f;
        }
        .info {
            background: rgba(0, 165, 255, 0.12);
            border: 1px solid rgba(0, 165, 255, 0.28);
            color: #0c5460;
        }
        
        /* Status Display Styles */
        .status-container {
            margin-top: 0;
            display: none;
        }
        .status-summary {
            display: flex;
            gap: 18px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .status-toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }
        .status-card {
            flex: 1 1 120px;
            min-width: 120px;
            background: linear-gradient(145deg, rgba(13, 123, 255, 0.08), rgba(0, 0, 0, 0));
            border: 1px solid rgba(13, 123, 255, 0.2);
            border-radius: 16px;
            padding: 18px 16px;
            text-align: center;
        }
        .status-card h4 {
            margin: 0 0 8px 0;
            color: #1a2f4d;
            font-weight: 600;
            font-size: 13px;
            letter-spacing: 0.02em;
            text-transform: uppercase;
        }
        .status-number {
            font-size: 28px;
            font-weight: 700;
            color: #0d7bff;
        }
        .search-container {
            width: 100%;
            margin-bottom: 20px;
        }
        
        .contact-search-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #c7d9ef;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: rgba(255, 255, 255, 0.95);
            color: var(--text-primary);
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .contact-search-input:focus {
            outline: none;
            border-color: #0d7bff;
            box-shadow: 0 0 0 3px rgba(13, 123, 255, 0.1);
        }
        
        .contact-search-input::placeholder {
            color: #9aa5b1;
        }
        
        .calls-table-wrapper {
            width: 100%;
            overflow-x: auto;
            padding-bottom: 4px;
            margin-top: 20px;
        }
        .calls-table {
            width: 100%;
            min-width: 920px;
            border-collapse: collapse;
        }
        .calls-table th, .calls-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .calls-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-scheduled { background-color: #fff3cd; color: #856404; }
        .status-calling { background-color: #cce5ff; color: #004085; }
        .status-completed { background-color: #d4edda; color: #155724; }
        .status-failed { background-color: #f8d7da; color: #721c24; }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #007cba;
            transition: width 0.3s ease;
        }
        
        .campaign-selector {
            margin-bottom: 20px;
            padding: 18px;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(16, 42, 67, 0.14);
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .campaign-selector label {
            font-weight: 600;
            margin-right: 10px;
            color: #1a2f4d;
        }
        .campaign-selector select {
            min-width: 280px;
            max-width: 100%;
            padding: 12px;
            border: 1px solid rgba(16, 42, 67, 0.18);
            border-radius: 10px;
            font-size: 14px;
            background-color: rgba(255, 255, 255, 0.95);
        }
        .campaign-info {
            margin-top: 0;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Add Lead Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
            align-items: center;
            justify-content: center;
        }

        .modal-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: #1a2f4d;
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: #f0f0f0;
        }

        .modal-content {
            padding: 0;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-content .form-row {
            margin-bottom: 20px;
        }

        .modal-content .form-row label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a2f4d;
        }

        .modal-content .form-row input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }

        /* Campaign Management Styles */
        .manage-campaigns-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.18s ease, box-shadow 0.18s ease;
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .manage-campaigns-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(108, 117, 125, 0.4);
        }

        .campaign-modal {
            position: relative;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            margin: auto;
        }

        .campaign-modal .modal-header h2 {
            margin: 0;
            color: #1a2f4d;
            font-size: 22px;
        }

        .campaigns-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .campaigns-table thead {
            background: rgba(0, 124, 186, 0.1);
        }

        .campaigns-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #1a2f4d;
            border-bottom: 2px solid rgba(0, 124, 186, 0.2);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .campaigns-table td {
            padding: 14px 12px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            color: #2c3e50;
            font-size: 14px;
        }

        .campaigns-table tbody tr:hover {
            background: rgba(0, 124, 186, 0.05);
        }

        .campaign-name {
            font-weight: 600;
            color: #1a2f4d;
        }

        .campaign-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .campaign-status.active {
            background: rgba(40, 167, 69, 0.15);
            color: #28a745;
        }

        .campaign-status.completed {
            background: rgba(0, 123, 255, 0.15);
            color: #007bff;
        }

        .campaign-status.inactive {
            background: rgba(108, 117, 125, 0.15);
            color: #6c757d;
        }

        .btn-delete-campaign {
            padding: 6px 14px;
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.3);
        }

        .btn-delete-campaign:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4);
        }

        .btn-delete-campaign:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Delete Confirmation Modal */
        .delete-confirm-modal {
            position: relative;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            margin: auto;
        }

        .delete-warning {
            color: #dc3545;
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(220, 53, 69, 0.1);
            border-radius: 8px;
            border-left: 4px solid #dc3545;
        }

        .delete-confirm-input {
            margin: 20px 0;
        }

        .delete-confirm-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a2f4d;
        }

        .delete-confirm-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .delete-confirm-input input:focus {
            outline: none;
            border-color: #dc3545;
        }

        .btn-delete {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .btn-delete:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(220, 53, 69, 0.4);
        }

        .btn-delete:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-cancel:hover {
            background: #5a6268;
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid rgba(0, 124, 186, 0.2);
            border-top: 3px solid #007cba;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .toast {
            min-width: 300px;
            max-width: 500px;
            padding: 16px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid;
        }

        .toast.success {
            border-left-color: #28a745;
        }

        .toast.error {
            border-left-color: #dc3545;
        }

        .toast.info {
            border-left-color: #007bff;
        }

        .toast-icon {
            font-size: 20px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: #2c3e50;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast-close:hover {
            color: #2c3e50;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .campaigns-table {
                font-size: 12px;
            }

            .campaigns-table th,
            .campaigns-table td {
                padding: 8px;
            }

            .campaign-modal {
                width: 95%;
                max-height: 90vh;
            }
        }

        .modal-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .modal-actions .cancel-btn {
            background: #f0f0f0;
            color: #333;
        }

        .modal-actions .cancel-btn:hover {
            background: #e0e0e0;
        }

        .modal-actions .submit-btn {
            background: #007cba;
            color: white;
        }

        .modal-actions .submit-btn:hover {
            background: #006ba1;
        }

        /* Action buttons in toolbar */
        .action-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .retry-btn, .add-lead-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .retry-btn:hover, .add-lead-btn:hover {
            background: #006ba1;
        }

        .retry-btn:disabled, .add-lead-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Table action buttons */
        .call-btn, .retry-single-btn, .crm-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
            margin-right: 4px;
        }

        .call-btn {
            background: #28a745;
            color: white;
        }

        .call-btn:hover {
            background: #218838;
        }

        .retry-single-btn {
            background: #ffc107;
            color: #333;
        }

        .retry-single-btn:hover {
            background: #e0a800;
        }

        .crm-btn {
            background: #6f42c1;
            color: white;
        }

        .crm-btn:hover {
            background: #5a32a3;
        }

        .crm-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        /* Checkbox styling */
        .call-checkbox {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        #selectAllCheckbox {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
    <div class="background-glow"></div>
    <div class="app-shell">
        <div class="top-bar glass-card">
            <div class="brand">
                <img src="https://statics.myclickfunnels.com/workspace/JGrmMP/image/16250065/file/6ef0e742dde95ca50252f19c9d65eecd.png" alt="LeadCallr logo">
                <span class="tagline">Sidd Sur's Workspace</span>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <a href="/admin" class="btn btn-primary" style="text-decoration: none; padding: 10px 22px; border-radius: 10px; font-size: 14px; font-weight: 600; background: linear-gradient(135deg, #6f42c1, #5a32a3); color: white; box-shadow: 0 12px 30px rgba(111, 66, 193, 0.35); transition: transform 0.18s ease, box-shadow 0.18s ease;">Admin</a>
                <button id="logoutBtn" class="logout-button">Log Out</button>
            </div>
        </div>
        <section class="intro-card glass-card">
            <h1>LeadCallr AI App</h1>
            <p>Upload a CSV file with contacts (Name, Phone, Address), define your calling window, and orchestrate campaigns powered by AI assistants.</p>
            <div class="intro-meta">
                <img src="https://statics.myclickfunnels.com/workspace/JGrmMP/image/16250088/file/f56b74313c1d6a8f3c0774060784aa1d.png" alt="LeadCallr emblem">
                <span>Outbound automation with AI</span>
            </div>
        </section>

        <div class="dashboard-layout">
            <!-- Collapsible Sidebar -->
            <aside id="sidebar" class="sidebar sidebar-expanded">
                <div class="sidebar-header" title="Campaign Tools - Click to expand">
                    <button id="sidebarToggle" class="sidebar-toggle" onclick="event.stopPropagation(); toggleSidebar();" title="Toggle Sidebar">
                        <span class="sidebar-toggle-icon">â˜°</span>
                    </button>
                    <h2 class="sidebar-title">Campaign Tools</h2>
                </div>
                <div class="sidebar-content">
                    <div class="time-settings glass-card panel-card">
                        <div class="section-title">
                            <h3>ðŸ“… Calling Schedule</h3>
                            <span class="section-subtitle">Define your daily window</span>
                        </div>
                        <div class="time-row">
                            <div class="time-group">
                                <label for="startTime">Start Time:</label>
                                <select id="startTime" name="startTime">
                                    <option value="06:00">6:00 AM</option>
                                    <option value="06:15">6:15 AM</option>
                                    <option value="06:30">6:30 AM</option>
                                    <option value="06:45">6:45 AM</option>
                                    <option value="07:00">7:00 AM</option>
                                    <option value="07:15">7:15 AM</option>
                                    <option value="07:30">7:30 AM</option>
                                    <option value="07:45">7:45 AM</option>
                                    <option value="08:00">8:00 AM</option>
                                    <option value="08:15">8:15 AM</option>
                                    <option value="08:30">8:30 AM</option>
                                    <option value="08:45">8:45 AM</option>
                                    <option value="09:00">9:00 AM</option>
                                    <option value="09:15">9:15 AM</option>
                                    <option value="09:30">9:30 AM</option>
                                    <option value="09:45">9:45 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="10:15">10:15 AM</option>
                                    <option value="10:30">10:30 AM</option>
                                    <option value="10:45">10:45 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="11:15">11:15 AM</option>
                                    <option value="11:30">11:30 AM</option>
                                    <option value="11:45">11:45 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="12:15">12:15 PM</option>
                                    <option value="12:30">12:30 PM</option>
                                    <option value="12:45">12:45 PM</option>
                                    <option value="13:00">1:00 PM</option>
                                    <option value="13:15">1:15 PM</option>
                                    <option value="13:30" selected>1:30 PM</option>
                                    <option value="13:45">1:45 PM</option>
                                    <option value="14:00">2:00 PM</option>
                                    <option value="14:15">2:15 PM</option>
                                    <option value="14:30">2:30 PM</option>
                                    <option value="14:45">2:45 PM</option>
                                    <option value="15:00">3:00 PM</option>
                                    <option value="15:15">3:15 PM</option>
                                    <option value="15:30">3:30 PM</option>
                                    <option value="15:45">3:45 PM</option>
                                    <option value="16:00">4:00 PM</option>
                                    <option value="16:15">4:15 PM</option>
                                    <option value="16:30">4:30 PM</option>
                                    <option value="16:45">4:45 PM</option>
                                    <option value="17:00">5:00 PM</option>
                                    <option value="17:15">5:15 PM</option>
                                    <option value="17:30">5:30 PM</option>
                                    <option value="17:45">5:45 PM</option>
                                    <option value="18:00">6:00 PM</option>
                                    <option value="18:15">6:15 PM</option>
                                    <option value="18:30">6:30 PM</option>
                                    <option value="18:45">6:45 PM</option>
                                    <option value="19:00">7:00 PM</option>
                                    <option value="19:15">7:15 PM</option>
                                    <option value="19:30">7:30 PM</option>
                                    <option value="19:45">7:45 PM</option>
                                    <option value="20:00">8:00 PM</option>
                                    <option value="20:15">8:15 PM</option>
                                    <option value="20:30">8:30 PM</option>
                                    <option value="20:45">8:45 PM</option>
                                    <option value="21:00">9:00 PM</option>
                                    <option value="21:15">9:15 PM</option>
                                    <option value="21:30">9:30 PM</option>
                                    <option value="21:45">9:45 PM</option>
                                    <option value="22:00">10:00 PM</option>
                                    <option value="22:15">10:15 PM</option>
                                    <option value="22:30">10:30 PM</option>
                                    <option value="22:45">10:45 PM</option>
                                    <option value="23:00">11:00 PM</option>
                                    <option value="23:15">11:15 PM</option>
                                    <option value="23:30">11:30 PM</option>
                                    <option value="23:45">11:45 PM</option>
                                    
                </select>
            </div>
            
            <div class="time-group">
                <label for="endTime">End Time:</label>
                <select id="endTime" name="endTime">
                                    <option value="07:00">7:00 AM</option>
                                    <option value="07:15">7:15 AM</option>
                                    <option value="07:30">7:30 AM</option>
                                    <option value="07:45">7:45 AM</option>
                                    <option value="08:00">8:00 AM</option>
                                    <option value="08:15">8:15 AM</option>
                                    <option value="08:30">8:30 AM</option>
                                    <option value="08:45">8:45 AM</option>
                                    <option value="09:00">9:00 AM</option>
                                    <option value="09:15">9:15 AM</option>
                                    <option value="09:30">9:30 AM</option>
                                    <option value="09:45">9:45 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="10:15">10:15 AM</option>
                                    <option value="10:30">10:30 AM</option>
                                    <option value="10:45">10:45 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="11:15">11:15 AM</option>
                                    <option value="11:30">11:30 AM</option>
                                    <option value="11:45">11:45 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="12:15">12:15 PM</option>
                                    <option value="12:30">12:30 PM</option>
                                    <option value="12:45">12:45 PM</option>
                                    <option value="13:00">1:00 PM</option>
                                    <option value="13:15">1:15 PM</option>
                                    <option value="13:30">1:30 PM</option>
                                    <option value="13:45">1:45 PM</option>
                                    <option value="14:00">2:00 PM</option>
                                    <option value="14:15">2:15 PM</option>
                                    <option value="14:30">2:30 PM</option>
                                    <option value="14:45">2:45 PM</option>
                                    <option value="15:00">3:00 PM</option>
                                    <option value="15:15">3:15 PM</option>
                                    <option value="15:30">3:30 PM</option>
                                    <option value="15:45">3:45 PM</option>
                                    <option value="16:00">4:00 PM</option>
                                    <option value="16:15">4:15 PM</option>
                                    <option value="16:30">4:30 PM</option>
                                    <option value="16:45">4:45 PM</option>
                                    <option value="17:00">5:00 PM</option>
                                    <option value="17:15">5:15 PM</option>
                                    <option value="17:30">5:30 PM</option>
                                    <option value="17:45">5:45 PM</option>
                                    <option value="18:00">6:00 PM</option>
                                    <option value="18:15">6:15 PM</option>
                                    <option value="18:30">6:30 PM</option>
                                    <option value="18:45">6:45 PM</option>
                                    <option value="19:00">7:00 PM</option>
                                    <option value="19:15">7:15 PM</option>
                                    <option value="19:30">7:30 PM</option>
                                    <option value="19:45">7:45 PM</option>
                                    <option value="20:00">8:00 PM</option>
                                    <option value="20:15">8:15 PM</option>
                                    <option value="20:30">8:30 PM</option>
                                    <option value="20:45">8:45 PM</option>
                                    <option value="21:00">9:00 PM</option>
                                    <option value="21:15">9:15 PM</option>
                                    <option value="21:30">9:30 PM</option>
                                    <option value="21:45">9:45 PM</option>
                                    <option value="22:00" selected>10:00 PM</option>
                                    <option value="22:15">10:15 PM</option>
                                    <option value="22:30">10:30 PM</option>
                                    <option value="22:45">10:45 PM</option>
                                    <option value="23:00">11:00 PM</option>
                                    <option value="23:15">11:15 PM</option>
                                    <option value="23:30">11:30 PM</option>
                                    <option value="23:45">11:45 PM</option>
                                                    <option value="23:59">11:59 PM</option>
                                </select>
                            </div>
                        </div>
                        <div id="timeInfo" class="info" style="margin-top: 10px; display: none;"></div>
                    </div>
                    
                    <div class="upload-container glass-card panel-card">
                        <div class="section-title">
                            <h3>ðŸ“‚ Upload & Schedule</h3>
                            <span class="section-subtitle">Attach contacts & launch</span>
                        </div>
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="form-row">
                                <label for="assistantSelect">Select AI Assistant</label>
                                <select id="assistantSelect" required>
                                    <option value="">Loading assistants...</option>
                                </select>
                                <small id="assistantHelpText" class="helper-text">Choose which AI agent will handle this campaign.</small>
                            </div>

                            <div class="form-row">
                                <label for="phoneNumberSelect">Select Caller ID (Phone Number)</label>
                                <select id="phoneNumberSelect" required>
                                    <option value="">Loading phone numbers...</option>
                                </select>
                                <small id="phoneHelpText" class="helper-text">Pick the phone number callers will see.</small>
                            </div>

                            <div class="file-input">
                                <input type="file" id="csvFile" name="csvFile" accept=".csv" required>
                                <p class="file-hint">Maximum 10,000 contacts per upload Â· CSV format only</p>
                            </div>
                            <div class="submit-actions">
                                <button type="submit" id="submitBtn">Upload and Schedule Calls</button>
                                <button type="button" id="cancelBtn" class="cancel-btn" style="display: none;">Cancel All Calls</button>
                            </div>
                        </form>
                    </div>
                    
                    <div id="result" class="result-banner glass-card"></div>
                </div>
            </aside>
            
            <!-- Main Content Area -->
            <div class="right-column main-content">
    
    <!-- Status Display Container -->
    <div id="statusContainer" class="status-container glass-card panel-card">
        <div class="section-title">
            <h3>ðŸ“Š Call Status Dashboard</h3>
            <span>Real-time campaign health</span>
        </div>

        <!-- Campaign Selector Dropdown -->
        <div class="campaign-selector">
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label for="campaignSelector">Select Campaign:</label>
                    <select id="campaignSelector" onchange="handleCampaignChange()">
                        <option value="">Loading campaigns...</option>
                    </select>
                </div>
                <button type="button" class="manage-campaigns-btn" onclick="openCampaignManagementModal()" style="margin-top: 20px;">
                    <span>âš™ï¸</span>
                    <span>Manage Campaigns</span>
                </button>
            </div>
            <div class="campaign-info" id="campaignInfo"></div>
        </div>

        <div class="status-toolbar">
            <div class="filter-buttons status-filters">
                <button type="button" onclick="filterByStatus('all')" class="filter-btn status-filter-btn active" id="status-filter-all">All Calls</button>
                <button type="button" onclick="filterByStatus('completed')" class="filter-btn status-filter-btn" id="status-filter-completed">Completed</button>
                <button type="button" onclick="filterByStatus('failed')" class="filter-btn status-filter-btn" id="status-filter-failed">Failed</button>
                <button type="button" onclick="filterByStatus('scheduled')" class="filter-btn status-filter-btn" id="status-filter-scheduled">Scheduled</button>
            </div>
            <div class="action-buttons">
                <button type="button" class="retry-btn" id="retrySelectedBtn" onclick="retrySelectedCalls()" style="display: none; margin-right: 10px;">
                    <span>ðŸ”„</span>
                    <span>Retry Selected</span>
                </button>
                <button type="button" class="add-lead-btn" onclick="openAddLeadModal()" style="margin-right: 10px;">
                    <span>âž•</span>
                    <span>Add New Lead</span>
                </button>
                <button type="button" class="analytics-btn" onclick="openAnalyticsPanel()">
                    <span>ðŸ“Š</span>
                    <span>Analytics</span>
                </button>
            </div>
        </div>

        <div class="filter-buttons outcome-filters" style="margin-bottom: 15px;">
            <button type="button" onclick="filterByOutcome('all')" class="filter-btn outcome-filter-btn active" id="outcome-filter-all">All Outcomes</button>
            <button type="button" onclick="filterByOutcome('interested')" class="filter-btn outcome-filter-btn" id="outcome-filter-interested">Interested</button>
            <button type="button" onclick="filterByOutcome('callback')" class="filter-btn outcome-filter-btn" id="outcome-filter-callback">Callback</button>
            <button type="button" onclick="filterByOutcome('send_listings')" class="filter-btn outcome-filter-btn" id="outcome-filter-send_listings">Send Listings</button>
            <button type="button" onclick="filterByOutcome('voicemail')" class="filter-btn outcome-filter-btn" id="outcome-filter-voicemail">Voicemail</button>
            <button type="button" onclick="filterByOutcome('do_not_call')" class="filter-btn outcome-filter-btn" id="outcome-filter-do_not_call">Do Not Call</button>
            <button type="button" onclick="filterByOutcome('unclear')" class="filter-btn outcome-filter-btn" id="outcome-filter-unclear">Unclear</button>
        </div>
        
        <div class="status-summary">
            <div class="status-card">
                <h4>Contacts</h4>
                <div class="status-number" id="totalContacts">0</div>
            </div>
            <div class="status-card">
                <h4>Total</h4>
                <div class="status-number" id="totalCalls">0</div>
            </div>
            <div class="status-card">
                <h4>Completed</h4>
                <div class="status-number" id="completedCalls">0</div>
            </div>
            <div class="status-card">
                <h4>Active</h4>
                <div class="status-number" id="activeCalls">0</div>
            </div>
            <div class="status-card">
                <h4>Scheduled</h4>
                <div class="status-number" id="scheduledCalls">0</div>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
        </div>
        <p id="progressText">0% complete</p>
        
        <div class="search-container" style="margin-bottom: 20px;">
            <input type="text" id="contactSearch" class="contact-search-input" placeholder="ðŸ” Search contacts by name or phone number..." autocomplete="off">
        </div>
        
        <div class="calls-table-wrapper">
            <table class="calls-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" title="Select All"></th>
                        <th>#</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Scheduled Time</th>
                        <th>Outcome</th>
                        <th>Summary</th>
                        <th>Recording</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="callsTableBody">
                </tbody>
            </table>
        </div>
    </div>
            </div>
        </div>

    <!-- Add Lead Modal -->
    <div id="addLeadOverlay" class="modal-overlay" onclick="closeAddLeadModal()"></div>
    <div id="addLeadModal" class="modal-panel" onclick="event.stopPropagation();">
        <div class="modal-header">
            <h3>Add New Lead</h3>
            <button class="modal-close" onclick="closeAddLeadModal()">Ã—</button>
        </div>
        <div class="modal-content">
            <form id="addLeadForm" onsubmit="handleAddLead(event)">
                <div class="form-row">
                    <label for="leadName">Name *</label>
                    <input type="text" id="leadName" name="name" required placeholder="Contact name">
                </div>
                <div class="form-row">
                    <label for="leadPhone">Phone *</label>
                    <input type="tel" id="leadPhone" name="phone" required placeholder="+1234567890">
                </div>
                <div class="form-row">
                    <label for="leadAddress">Address</label>
                    <input type="text" id="leadAddress" name="address" placeholder="Contact address (optional)">
                </div>
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeAddLeadModal()">Cancel</button>
                    <button type="submit" class="submit-btn">Add Lead</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Analytics Panel -->
    <div id="analyticsOverlay" class="analytics-overlay" onclick="closeAnalyticsPanel()"></div>
    <div id="analyticsPanel" class="analytics-panel" onclick="event.stopPropagation();">
        <div class="analytics-header">
            <h3>Campaign Analytics</h3>
            <button class="analytics-close" onclick="closeAnalyticsPanel()">Ã—</button>
        </div>
        <div class="analytics-content">
            <div id="analyticsLoading" style="display:none; text-align:center; padding:30px;">Loading analytics...</div>
            <div id="analyticsEmpty" class="analytics-empty" style="display:none;">
                No completed calls yet. Analytics will appear once calls are processed.
            </div>
            <div id="analyticsBody" style="display:none;">
                <div class="analytics-summary">
                    <div class="analytics-card">
                        <h4>Total calls</h4>
                        <div class="value" id="analyticsTotal">0</div>
                        <div class="sub" id="analyticsTotalSub">All calls placed</div>
                    </div>
                    <div class="analytics-card">
                        <h4>Answered</h4>
                        <div class="value" id="analyticsAnswered">0</div>
                        <div class="sub" id="analyticsAnsweredSub">0%</div>
                    </div>
                    <div class="analytics-card">
                        <h4>Voicemail</h4>
                        <div class="value" id="analyticsVoicemail">0</div>
                        <div class="sub" id="analyticsVoicemailSub">0%</div>
                    </div>
                    <div class="analytics-card">
                        <h4>Retries</h4>
                        <div class="value" id="analyticsRetries">0</div>
                        <div class="sub" id="analyticsRetriesSub">Voicemail follow-ups</div>
                    </div>
                </div>

                <div class="analytics-chart">
                    <h4 style="margin-bottom:10px; color:#0d4f7c;">Answered vs Voicemail</h4>
                    <canvas id="analyticsAnswerChart" height="180"></canvas>
                </div>

                <div class="analytics-chart">
                    <h4 style="margin-bottom:10px; color:#0d4f7c;">Outcome Distribution (Answered Calls)</h4>
                    <canvas id="analyticsOutcomeChart" height="200"></canvas>
                </div>

                <div id="analyticsOutcomeTable"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let statusUpdateInterval = null;
        let selectedCampaignId = null; // Track currently selected campaign
        let allCampaigns = []; // Store all campaigns
        let currentStatusFilter = 'all';
        let currentOutcomeFilter = 'all';
        let currentSearchQuery = ''; // Store current search query
        let analyticsAnswerChart = null;
        let analyticsOutcomeChart = null;
        let availableAssistants = [];
        let availablePhoneNumbers = [];
        let addedToCRM = new Set(); // Track contacts that have been successfully added to CRM (status 200)
        let failedCRM = new Set(); // Track contacts that failed to add to CRM (for "Try Again" button)

        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                logoutBtn.disabled = true;
                logoutBtn.textContent = 'Logging out...';
                try {
                    await fetch('/logout', { method: 'POST' });
                } catch (error) {
                    console.error('Error logging out:', error);
                } finally {
                    window.location.href = '/login';
                }
            });
        }
        
        // Check for existing campaigns on page load
        window.addEventListener('load', async function() {
            console.log('ðŸ”„ Page loaded, checking for existing campaigns...');
            await loadCallResources();
            await loadCampaignsAndStatus();
            
            // Set up search input event listener
            const searchInput = document.getElementById('contactSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    currentSearchQuery = e.target.value;
                    applyFilters();
                });
            }
        });
        
        function setHelperText(id, message, isError = false) {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = message;
            if (isError) {
                el.classList.add('error');
            } else {
                el.classList.remove('error');
            }
        }

        async function loadCallResources() {
            const assistantSelect = document.getElementById('assistantSelect');
            const phoneNumberSelect = document.getElementById('phoneNumberSelect');
            const submitBtn = document.getElementById('submitBtn');

            if (!assistantSelect || !phoneNumberSelect) {
                return;
            }

            assistantSelect.disabled = true;
            phoneNumberSelect.disabled = true;

            setHelperText('assistantHelpText', 'Loading assistants...');
            setHelperText('phoneHelpText', 'Loading phone numbers...');

            const previousAssistant = assistantSelect.value;
            const previousPhone = phoneNumberSelect.value;

            assistantSelect.innerHTML = '<option value="">Loading assistants...</option>';
            phoneNumberSelect.innerHTML = '<option value="">Loading phone numbers...</option>';

            try {
                const response = await fetch('/api/resources');
                if (!response.ok) {
                    throw new Error(`Server responded with ${response.status}`);
                }

                const data = await response.json();
                availableAssistants = Array.isArray(data.assistants) ? data.assistants : [];
                availablePhoneNumbers = Array.isArray(data.phoneNumbers) ? data.phoneNumbers : [];

                populateAssistantDropdown(availableAssistants, previousAssistant);
                populatePhoneNumberDropdown(availablePhoneNumbers, previousPhone);

                const hasAssistants = availableAssistants.length > 0;
                const hasPhoneNumbers = availablePhoneNumbers.length > 0;

                assistantSelect.disabled = !hasAssistants;
                phoneNumberSelect.disabled = !hasPhoneNumbers;

                if (hasAssistants) {
                    setHelperText('assistantHelpText', 'Choose which AI agent will handle this campaign.');
                } else {
                    setHelperText('assistantHelpText', 'No assistants found yet. Run the helper script to add one.', true);
                }

                if (hasPhoneNumbers) {
                    setHelperText('phoneHelpText', 'Pick the phone number callers will see.');
                } else {
                    setHelperText('phoneHelpText', 'No phone numbers found yet. Run the helper script to add one.', true);
                }

                if (submitBtn) {
                    submitBtn.disabled = !(hasAssistants && hasPhoneNumbers);
                    submitBtn.title = submitBtn.disabled
                        ? 'Add an assistant and phone number before scheduling calls.'
                        : '';
                }

            } catch (error) {
                console.error('Error loading assistants/phone numbers:', error);
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.title = 'Unable to load required data. Refresh the page and try again.';
                }
                assistantSelect.innerHTML = '<option value="">Unable to load assistants</option>';
                phoneNumberSelect.innerHTML = '<option value="">Unable to load phone numbers</option>';
                setHelperText('assistantHelpText', 'Unable to load assistants. Please refresh and try again.', true);
                setHelperText('phoneHelpText', 'Unable to load phone numbers. Please refresh and try again.', true);
            }
        }

        function populateAssistantDropdown(assistants, selectedValue = '') {
            const select = document.getElementById('assistantSelect');
            if (!select) return;

            select.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = assistants.length > 0 ? 'Select an assistant...' : 'No assistants available';
            placeholder.disabled = assistants.length > 0;
            placeholder.selected = true;
            select.appendChild(placeholder);

            assistants.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item.name || item.id;
                select.appendChild(option);
            });

            if (selectedValue && assistants.some(item => item.id === selectedValue)) {
                select.value = selectedValue;
                placeholder.selected = false;
            } else if (assistants.length === 1) {
                select.value = assistants[0].id;
                placeholder.selected = false;
            }
        }

        function populatePhoneNumberDropdown(phoneNumbers, selectedValue = '') {
            const select = document.getElementById('phoneNumberSelect');
            if (!select) return;

            select.innerHTML = '';
            const placeholder = document.createElement('option');
            placeholder.value = '';
            placeholder.textContent = phoneNumbers.length > 0 ? 'Select a phone number...' : 'No phone numbers available';
            placeholder.disabled = phoneNumbers.length > 0;
            placeholder.selected = true;
            select.appendChild(placeholder);

            phoneNumbers.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                const label = item.displayName || item.phoneNumber || item.id;
                option.textContent = label;
                select.appendChild(option);
            });

            if (selectedValue && phoneNumbers.some(item => item.id === selectedValue)) {
                select.value = selectedValue;
                placeholder.selected = false;
            } else if (phoneNumbers.length === 1) {
                select.value = phoneNumbers[0].id;
                placeholder.selected = false;
            }
        }

        // NEW: Load all campaigns and populate dropdown
        async function loadCampaigns() {
            try {
                const response = await fetch('/api/campaigns');
                const data = await response.json();
                
                if (data.campaigns && data.campaigns.length > 0) {
                    allCampaigns = data.campaigns;
                    populateCampaignDropdown(data.campaigns);
                    return data.campaigns;
                } else {
                    console.log('ðŸ“­ No campaigns found');
                    const selector = document.getElementById('campaignSelector');
                    selector.innerHTML = '<option value="">No campaigns found</option>';
                    return [];
                }
            } catch (error) {
                console.error('Error loading campaigns:', error);
                const selector = document.getElementById('campaignSelector');
                selector.innerHTML = '<option value="">Error loading campaigns</option>';
                return [];
            }
        }
        
        // NEW: Populate campaign dropdown
        function populateCampaignDropdown(campaigns) {
            const selector = document.getElementById('campaignSelector');
            selector.innerHTML = ''; // Clear existing options
            
            campaigns.forEach(campaign => {
                const option = document.createElement('option');
                option.value = campaign.campaignId;
                
                // Format the date for display
                let dateStr = 'Date unknown';
                if (campaign.createdAt) {
                    const date = new Date(campaign.createdAt);
                    if (!isNaN(date.getTime())) {
                        dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                }
                
                const assistantLabel = campaign.assistantName || 'Assistant not set';
                const phoneLabel = campaign.phoneNumberName || 'Number not set';
                
                // Create a nice display label
                option.textContent = `${campaign.campaignId} â€¢ ${assistantLabel} â€¢ ${phoneLabel} (${dateStr})`;
                option.setAttribute('data-campaign', JSON.stringify(campaign));
                selector.appendChild(option);
            });
            
            // If we have a selected campaign, set it in the dropdown
            if (selectedCampaignId) {
                selector.value = selectedCampaignId;
                updateCampaignInfo(selectedCampaignId);
            } else if (campaigns.length > 0) {
                // Select the first (most recent) campaign by default
                selectedCampaignId = campaigns[0].campaignId;
                selector.value = selectedCampaignId;
                updateCampaignInfo(selectedCampaignId);
            }
        }
        
        // NEW: Update campaign info display
        function updateCampaignInfo(campaignId) {
            const campaign = allCampaigns.find(c => c.campaignId === campaignId);
            const infoDiv = document.getElementById('campaignInfo');
            
            if (campaign) {
                let dateStr = 'Date unknown';
                if (campaign.createdAt) {
                    const date = new Date(campaign.createdAt);
                    if (!isNaN(date.getTime())) {
                        dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                }
                const assistantLabel = campaign.assistantName || 'Not recorded';
                const phoneLabel = campaign.phoneNumberName || 'Not recorded';
                infoDiv.innerHTML = `
                    <strong>Campaign Info:</strong> 
                    Assistant: ${assistantLabel} | 
                    Caller ID: ${phoneLabel}<br>
                    ${campaign.callCount} total calls | 
                    ${campaign.completedCount || 0} completed | 
                    ${campaign.successfulCount || 0} successful | 
                    Created: ${dateStr}
                `;
            } else {
                infoDiv.innerHTML = '';
            }
        }
        
        // NEW: Handle campaign selection change
        function handleCampaignChange() {
            const selector = document.getElementById('campaignSelector');
            selectedCampaignId = selector.value;
            
            if (selectedCampaignId) {
                updateCampaignInfo(selectedCampaignId);
                // Update the status display with the selected campaign
                updateCallStatus();
            }
        }
        
        // NEW: Combined function to load campaigns and check for existing status
        async function loadCampaignsAndStatus() {
            // First load all campaigns
            const campaigns = await loadCampaigns();
            
            // If we have campaigns, show the status container
            if (campaigns && campaigns.length > 0) {
                document.getElementById('statusContainer').style.display = 'block';
                
                // Then check for existing campaign status
                try {
                    const campaignId = selectedCampaignId || null;
                    const url = campaignId ? `/status?campaignId=${campaignId}` : '/status';
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.calls && data.calls.length > 0) {
                        console.log('ðŸŽ¯ Found existing campaign with', data.calls.length, 'calls');
                        
                        // Update selected campaign ID if we got one from the server
                        if (data.campaignId) {
                            selectedCampaignId = data.campaignId;
                            const selector = document.getElementById('campaignSelector');
                            if (selector) {
                                selector.value = data.campaignId;
                                updateCampaignInfo(data.campaignId);
                            }
                        }
                        
                        // Show cancel button only if viewing the current/active campaign
                        if (data.isCurrentCampaign && data.summary && (data.summary.scheduled > 0 || data.timers > 0)) {
                            document.getElementById('cancelBtn').style.display = 'inline-block';
                        } else {
                            document.getElementById('cancelBtn').style.display = 'none';
                        }
                        
                        // Show loading message
                        const resultDiv = document.getElementById('result');
                        resultDiv.innerHTML = `
                            <div class="info">
                                <strong>ðŸ“Š Loaded campaign</strong><br>
                                Found ${data.calls.length} calls<br>
                                Campaign ID: ${data.campaignId || 'Unknown'}
                            </div>
                        `;
                        
                        startStatusUpdates();
                    } else {
                        // Campaign exists but has no calls yet, still show the container
                        updateCallStatus();
                    }
                } catch (error) {
                    console.error('Error checking for existing campaigns:', error);
                    // Still show the container if we have campaigns
                    updateCallStatus();
                }
            } else {
                console.log('ðŸ“­ No campaigns found');
            }
        }
        
        // DEPRECATED: Function to check for existing campaigns (keeping for backward compatibility)
        async function checkForExistingCampaigns() {
            // This function is now replaced by loadCampaignsAndStatus
            await loadCampaignsAndStatus();
        }
        
        // Update time window info when times change
        function updateTimeInfo() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const timeInfo = document.getElementById('timeInfo');
            
            const start = new Date(`2024-01-01 ${startTime}`);
            const end = new Date(`2024-01-01 ${endTime}`);
            
            if (end <= start) {
                timeInfo.innerHTML = 'âš ï¸ End time must be after start time';
                timeInfo.className = 'error';
                timeInfo.style.display = 'block';
                return false;
            }
            
            const durationHours = (end - start) / (1000 * 60 * 60);
            timeInfo.innerHTML = `âœ… Calling window: ${durationHours} hours (${startTime} to ${endTime})`;
            timeInfo.className = 'info';
            timeInfo.style.display = 'block';
            return true;
        }
        
        // Add event listeners for time changes
        document.getElementById('startTime').addEventListener('change', updateTimeInfo);
        document.getElementById('endTime').addEventListener('change', updateTimeInfo);
        
        // Initialize time info
        updateTimeInfo();

        function normalizeOutcomeValue(value) {
            if (!value) return 'unknown';
            return value.toString().trim().toLowerCase().replace(/[\s-]+/g, '_');
        }

        function formatOutcomeLabel(value) {
            if (!value) return 'UNKNOWN';
            return value.toString().replace(/[_-]+/g, ' ').toUpperCase();
        }

        function getOutcomeClass(value) {
            switch (value) {
                case 'interested': return 'outcome-interested';
                case 'voicemail': return 'outcome-voicemail';
                case 'send_listings': return 'outcome-listings';
                case 'callback': return 'outcome-callback';
                case 'not_interested':
                case 'do_not_call':
                    return 'outcome-not-interested';
                default:
                    return 'outcome-other';
            }
        }

        // Function to update call status display (now supports campaign selection)
        async function updateCallStatus() {
            try {
                // Use selected campaign ID if available, otherwise use default
                const campaignId = selectedCampaignId || null;
                const url = campaignId ? `/status?campaignId=${campaignId}` : '/status';
                const response = await fetch(url);
                const data = await response.json();
                
                // Update selected campaign ID from response if we don't have one
                if (data.campaignId && !selectedCampaignId) {
                    selectedCampaignId = data.campaignId;
                    const selector = document.getElementById('campaignSelector');
                    if (selector) {
                        selector.value = data.campaignId;
                        updateCampaignInfo(data.campaignId);
                    }
                }
                
                // Update campaign info if we have the campaign ID
                if (data.campaignId && selectedCampaignId === data.campaignId) {
                    updateCampaignInfo(data.campaignId);
                }
                
                // Show/hide cancel button based on whether this is the current active campaign
                // Only show cancel button if this is the current campaign (has active timers/scheduled calls)
                if (data.isCurrentCampaign && data.summary && (data.summary.scheduled > 0 || data.timers > 0)) {
                    document.getElementById('cancelBtn').style.display = 'inline-block';
                } else {
                    // Hide cancel button for past campaigns
                    document.getElementById('cancelBtn').style.display = 'none';
                }
                
                // Update summary cards (contact count will be updated after we group the calls)
                document.getElementById('totalCalls').textContent = data.summary.total;
                document.getElementById('completedCalls').textContent = data.summary.completed;
                document.getElementById('activeCalls').textContent = data.summary.active;
                document.getElementById('scheduledCalls').textContent = data.summary.scheduled;
                
                // Update progress bar
                const progress = data.summary.total > 0 ? (data.summary.completed / data.summary.total) * 100 : 0;
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('progressText').textContent = `${Math.round(progress)}% complete (${data.summary.completed}/${data.summary.total})`;
                
                // PRESERVE EDIT STATES, EXPANDED SUMMARIES, AND CHECKBOX SELECTIONS
                const tableBody = document.getElementById('callsTableBody');
                
                // Save current edit states and expanded summaries before updating table
                // Use callId as key for more reliable tracking across updates
                const editStates = {};
                const expandedStates = window.expandedStates || {};
                
                // Preserve checkbox selections
                const selectedCallIds = window.selectedCallIds || new Set();
                document.querySelectorAll('.call-checkbox:checked').forEach(checkbox => {
                    const callId = parseInt(checkbox.dataset.callId);
                    if (callId) {
                        selectedCallIds.add(callId);
                    }
                });
                window.selectedCallIds = selectedCallIds;
                
                // Check all existing summary-expanded elements to preserve state
                const allExpanded = document.querySelectorAll('[id^="summary-expanded-"]');
                allExpanded.forEach(expandedDiv => {
                    if (expandedDiv && expandedDiv.style.display !== 'none') {
                        const id = expandedDiv.id;
                        // Extract the identifier (callId or index)
                        const match = id.match(/summary-expanded-(.+)/);
                        if (match) {
                            expandedStates[match[1]] = true;
                        }
                    }
                });
                
                // Store expanded states globally so they persist across updates
                window.expandedStates = expandedStates;

                // Update table
                tableBody.innerHTML = '';

                // Group calls by original call (for retries)
                const callsByOriginal = {};
                const originalCalls = [];
                
                data.calls.forEach((call, index) => {
                    if (call.isRetry && call.originalCallId) {
                        // This is a retry call
                        if (!callsByOriginal[call.originalCallId]) {
                            callsByOriginal[call.originalCallId] = [];
                        }
                        callsByOriginal[call.originalCallId].push({ call, index });
                    } else {
                        // This is an original call
                        originalCalls.push({ call, index });
                    }
                });
                
                // Sort original calls by index (nulls last for manual leads)
                originalCalls.sort((a, b) => {
                    if (a.call.index === null || a.call.index === undefined) return 1;
                    if (b.call.index === null || b.call.index === undefined) return -1;
                    return (a.call.index || 0) - (b.call.index || 0);
                });
                
                // Update unique contacts count (original calls only, excluding retries)
                const uniqueContactsCount = originalCalls.length;
                document.getElementById('totalContacts').textContent = uniqueContactsCount;
                
                // Display calls: original calls first, then their retries
                // Only increment displayIndex for original calls to show true contact count
                let displayIndex = 0;
                originalCalls.forEach(({ call, index: originalIndex }) => {
                    // Display the original call - pass expandedStates
                    const row = createCallRow(call, displayIndex, false, null, expandedStates);
                    tableBody.appendChild(row);
                    displayIndex++; // Only increment for original calls (contacts)
                    
                    // Display retries for this call if any
                    // Retries don't increment displayIndex - they show â†ª and don't affect contact numbering
                    if (callsByOriginal[call.callId]) {
                        callsByOriginal[call.callId].forEach(({ call: retryCall }) => {
                            // Pass -1 or null as displayIndex for retries since they don't show a number
                            const retryRow = createCallRow(retryCall, -1, true, call.callId, expandedStates);
                            tableBody.appendChild(retryRow);
                            // Don't increment displayIndex for retries - they're not separate contacts
                        });
                    }
                });
                
                // Restore select all checkbox state
                const allCheckboxes = document.querySelectorAll('.call-checkbox');
                const checkedCheckboxes = document.querySelectorAll('.call-checkbox:checked');
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                if (selectAllCheckbox && allCheckboxes.length > 0) {
                    selectAllCheckbox.checked = (checkedCheckboxes.length === allCheckboxes.length);
                }
                
                // Update retry button visibility after restoring checkboxes
                updateRetryButtonVisibility();
                
                // Apply active filters
                applyFilters();
                
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }
        
        // Helper function to format date/time in Eastern Time
        function formatEasternTime(date) {
            if (!date || isNaN(date.getTime())) {
                return null;
            }
            
            // Use Intl.DateTimeFormat for proper timezone conversion
            const easternFormatter = new Intl.DateTimeFormat('en-US', {
                timeZone: 'America/New_York',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            
            const dateFormatter = new Intl.DateTimeFormat('en-US', {
                timeZone: 'America/New_York',
                month: '2-digit',
                day: '2-digit',
                year: 'numeric'
            });
            
            // Format time in Eastern Time
            const timeStr = easternFormatter.format(date);
            
            // Format date in Eastern Time as mm/dd/yyyy
            const dateParts = dateFormatter.formatToParts(date);
            const month = dateParts.find(part => part.type === 'month').value;
            const day = dateParts.find(part => part.type === 'day').value;
            const year = dateParts.find(part => part.type === 'year').value;
            const dateStr = `${month}/${day}/${year}`;
            
            return { timeStr, dateStr };
        }

        // NEW: Helper function to create a call row
        function createCallRow(call, displayIndex, isRetry, originalCallId, expandedStates) {
            // Use global expandedStates if not provided
            if (!expandedStates) {
                expandedStates = window.expandedStates || {};
            }
            
            const row = document.createElement('tr');
            
            // Add retry styling and indicator
            if (isRetry) {
                row.style.backgroundColor = '#f8f9fa';
                row.style.opacity = '0.9';
                row.classList.add('retry-row');
            }
            
            // Determine status display
            let statusClass, statusText;
            if (call.status === 'completed') {
                statusClass = 'status-completed';
                statusText = 'âœ… Completed';
            } else if (call.status === 'calling') {
                statusClass = 'status-calling';
                statusText = 'ðŸ“ž Calling';
            } else if (call.status === 'failed') {
                statusClass = 'status-failed';
                statusText = 'âŒ Failed';
            } else {
                statusClass = 'status-scheduled';
                statusText = 'â° Scheduled';
            }
            
            let statusValue = (call.status || '').toLowerCase();
            if (statusValue === 'calling') statusValue = 'scheduled';
            if (!statusValue) statusValue = 'unknown';
            
            // Format scheduled time to show both time (large) and date (small, below) in mm/dd/yyyy format
            // For each call/retry, show the time and date when that particular call was made/scheduled
            // Use scheduledTimeLocal directly (already in Eastern Time) and get date from timestamp
            let scheduledTime = '-';
            let timeStr = null;
            let dateStr = null;
            
            // Priority 1: Use scheduledTimeLocal if available (already formatted in Eastern Time)
            if (call.scheduledTimeLocal) {
                timeStr = call.scheduledTimeLocal;
                // Get date from timestamp or scheduledTime, convert to Eastern Time
                let dateSource = null;
                if (call.status === 'completed' && call.timestamp) {
                    dateSource = new Date(call.timestamp);
                } else if (call.scheduledTime) {
                    dateSource = new Date(call.scheduledTime);
                } else if (call.timestamp) {
                    dateSource = new Date(call.timestamp);
                }
                
                if (dateSource && !isNaN(dateSource.getTime())) {
                    const formatted = formatEasternTime(dateSource);
                    if (formatted) {
                        dateStr = formatted.dateStr;
                    }
                }
            } 
            // Priority 2: Use scheduledTime and convert to Eastern Time
            else if (call.scheduledTime) {
                const dateObj = new Date(call.scheduledTime);
                if (!isNaN(dateObj.getTime())) {
                    const formatted = formatEasternTime(dateObj);
                    if (formatted) {
                        timeStr = formatted.timeStr;
                        dateStr = formatted.dateStr;
                    }
                }
            }
            // Priority 3: Use timestamp and convert to Eastern Time
            else if (call.timestamp) {
                const dateObj = new Date(call.timestamp);
                if (!isNaN(dateObj.getTime())) {
                    const formatted = formatEasternTime(dateObj);
                    if (formatted) {
                        timeStr = formatted.timeStr;
                        dateStr = formatted.dateStr;
                    }
                }
            }
            // Priority 4: Try to extract from message
            else if (call.message && call.message.includes('Scheduled for')) {
                const timeMatch = call.message.match(/Scheduled for (.+)/);
                if (timeMatch) {
                    const msgDate = new Date(timeMatch[1]);
                    if (!isNaN(msgDate.getTime())) {
                        const formatted = formatEasternTime(msgDate);
                        if (formatted) {
                            timeStr = formatted.timeStr;
                            dateStr = formatted.dateStr;
                        } else {
                            timeStr = timeMatch[1];
                        }
                    } else {
                        timeStr = timeMatch[1];
                    }
                }
            }
            
            // Last resort: use current date/time if completed but no data
            if (scheduledTime === '-' && call.status === 'completed' && !timeStr) {
                const now = new Date();
                const formatted = formatEasternTime(now);
                if (formatted) {
                    timeStr = formatted.timeStr;
                    dateStr = formatted.dateStr;
                }
            }
            
            // Build the display string
            if (timeStr) {
                if (dateStr) {
                    scheduledTime = `<div style="font-size: 14px; font-weight: 600;">${timeStr}</div><div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">${dateStr}</div>`;
                } else {
                    // If we have time but no date, try to get date from timestamp
                    let dateSource = null;
                    if (call.timestamp) {
                        dateSource = new Date(call.timestamp);
                    } else if (call.scheduledTime) {
                        dateSource = new Date(call.scheduledTime);
                    }
                    if (dateSource && !isNaN(dateSource.getTime())) {
                        const formatted = formatEasternTime(dateSource);
                        if (formatted) {
                            dateStr = formatted.dateStr;
                            scheduledTime = `<div style="font-size: 14px; font-weight: 600;">${timeStr}</div><div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">${dateStr}</div>`;
                        } else {
                            scheduledTime = timeStr;
                        }
                    } else {
                        scheduledTime = timeStr;
                    }
                }
            }
            
            // Format name display with retry indicator
            let nameDisplay = call.contact.name;
            if (isRetry) {
                nameDisplay = `â†ª ${nameDisplay} <small style="color: #6c757d;">(Retry)</small>`;
            }
            
            // Normalize structured data if it arrived as a string
            let structuredData = null;
            if (call.structuredData) {
                if (typeof call.structuredData === 'string') {
                    try {
                        structuredData = JSON.parse(call.structuredData);
                    } catch (e) {
                        structuredData = null;
                    }
                } else {
                    structuredData = call.structuredData;
                }
            }
            
            // Determine outcome for filtering and display
            let rawOutcome = '';
            if (structuredData && structuredData.CallOutcome) {
                rawOutcome = structuredData.CallOutcome;
            } else if (call.callOutcome) {
                rawOutcome = call.callOutcome;
            } else if (call.status === 'completed' && call.endedReason) {
                rawOutcome = call.endedReason;
            }
            
            const normalizedOutcome = normalizeOutcomeValue(rawOutcome);
            const outcomeClass = getOutcomeClass(normalizedOutcome);
            const outcomeLabel = rawOutcome ? formatOutcomeLabel(rawOutcome) : 'UNKNOWN';
            
            let outcomeDisplay = '-';
            if (rawOutcome) {
                outcomeDisplay = `<span class="${outcomeClass}"><strong>${outcomeLabel}</strong></span>`;
                if (structuredData) {
                    const details = [];
                    if (structuredData.Answered) details.push(`Answered: ${structuredData.Answered}`);
                    if (structuredData.Date) details.push(`Date: ${structuredData.Date}`);
                    if (structuredData.Email) details.push(`Email: ${structuredData.Email}`);
                    if (details.length > 0) {
                        outcomeDisplay += `<br><small>${details.join(' | ')}</small>`;
                    }
                }
            } else if (call.status === 'completed') {
                outcomeDisplay = `<span class="${outcomeClass}"><strong>NO OUTCOME DATA</strong></span>`;
            }
            
            row.dataset.status = statusValue;
            row.dataset.outcome = normalizedOutcome;
            
            // Format summary - use callId for stable identification across updates
            let summaryDisplay = '-';
            if (call.summary) {
                const shortSummary = call.summary.length > 100 ? 
                    call.summary.substring(0, 100) + '...' : call.summary;
                
                if (call.summary.length > 100) {
                    // Use callId if available (all calls including retries should have this)
                    // Fall back to database ID, then displayIndex (only if >= 0), then a generated ID
                    const summaryId = call.callId || call.id || (displayIndex >= 0 ? `call-${displayIndex}` : `call-${call.id || 'unknown'}`);
                    // Check expanded state from parameter or global state
                    const stateToCheck = expandedStates || window.expandedStates || {};
                    const isExpanded = stateToCheck[summaryId] === true;
                    
                    summaryDisplay = `
                        <div class="summary-container">
                            <div class="summary-short" id="summary-short-${summaryId}" style="${isExpanded ? 'display: none;' : ''}">
                                ${shortSummary}
                                <br><span class="see-more-btn" onclick="toggleSummaryById('${summaryId}')">See more</span>
                            </div>
                            <div class="summary-expanded" id="summary-expanded-${summaryId}" style="${isExpanded ? '' : 'display: none;'}">
                                ${call.summary}
                                <br><span class="see-more-btn" onclick="toggleSummaryById('${summaryId}')">See less</span>
                            </div>
                        </div>
                    `;
                } else {
                    summaryDisplay = call.summary;
                }
            }

            // Format recording link
            let recordingDisplay = '-';
            if (call.recordingUrl) {
                recordingDisplay = `<button class="recording-btn" onclick="window.open('${call.recordingUrl}', '_blank')">ðŸŽµ Play</button>`;
            }

            // Determine if this is a manual lead (no index) or scheduled call that can be called manually
            const isManualLead = call.index === null || call.index === undefined;
            const canCallManually = isManualLead && (call.status === 'scheduled' || call.status === 'failed');
            const canRetry = (call.status === 'completed' || call.status === 'failed') && !isRetry;
            
            // Create checkbox - only show for calls that can be retried or called
            const dbCallId = call.id;
            let checkbox = '';
            if (dbCallId && (canCallManually || canRetry)) {
                const checkboxId = `call-checkbox-${dbCallId}`;
                // Check if this call was previously selected
                const isSelected = window.selectedCallIds && window.selectedCallIds.has(dbCallId);
                const checkedAttr = isSelected ? 'checked' : '';
                checkbox = `<input type="checkbox" class="call-checkbox" id="${checkboxId}" data-call-id="${dbCallId}" ${checkedAttr} onchange="updateRetryButtonVisibility()">`;
            } else {
                checkbox = ''; // No checkbox for calls that can't be retried/called
            }
            
            // Create actions column
            let actionsHtml = [];
            if (canCallManually && dbCallId) {
                actionsHtml.push(`<button class="call-btn" onclick="callLead(${dbCallId})" title="Call this lead">ðŸ“ž Call</button>`);
            } else if (canRetry && dbCallId) {
                actionsHtml.push(`<button class="retry-single-btn" onclick="retrySingleCall(${dbCallId})" title="Retry this call">ðŸ”„ Retry</button>`);
            }
            
            // Add "Add to CRM" button for completed calls
            if (call.status === 'completed' && dbCallId) {
                if (addedToCRM.has(dbCallId)) {
                    // Successfully added (status 200) - show disabled "Added" button
                    actionsHtml.push(`<button class="crm-btn" disabled style="background: #6c757d; cursor: not-allowed;" title="Already added to CRM">âœ“ Added</button>`);
                } else if (failedCRM.has(dbCallId)) {
                    // Failed to add - show "Try Again" button
                    actionsHtml.push(`<button class="crm-btn" onclick="addToCRM(${dbCallId})" title="Retry sending to CRM" style="background: #dc3545;">ðŸ”„ Try Again</button>`);
                } else {
                    // Not yet attempted - show active "Add to CRM" button
                    actionsHtml.push(`<button class="crm-btn" onclick="addToCRM(${dbCallId})" title="Send to CRM">ðŸ“¤ Add to CRM</button>`);
                }
            }
            
            const actionsDisplay = actionsHtml.length > 0 ? actionsHtml.join(' ') : '-';
            
            row.innerHTML = `
                <td>${checkbox}</td>
                <td>${isRetry ? 'â†ª' : displayIndex + 1}</td>
                <td>${nameDisplay}</td>
                <td>${call.contact.phone}</td>
                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                <td>${scheduledTime}</td>
                <td>${outcomeDisplay}</td>
                <td>${summaryDisplay}</td>
                <td>${recordingDisplay}</td>
                <td>${actionsDisplay}</td>
            `;
            
            // Store database ID in row data attribute
            if (call.id) {
                row.dataset.dbCallId = call.id;
            }
            
            // Store contact name and phone for search filtering (normalize for case-insensitive search)
            const contactName = (call.contact.name || '').toLowerCase().trim();
            const contactPhone = (call.contact.phone || '').toLowerCase().trim();
            row.dataset.contactName = contactName;
            row.dataset.contactPhone = contactPhone;
            
            return row;
        }
        
        // Start status updates
        function startStatusUpdates() {
            updateCallStatus(); // Update immediately
            statusUpdateInterval = setInterval(updateCallStatus, 2000); // Update every 2 seconds
        }
        
        // Stop status updates
        function stopStatusUpdates() {
            if (statusUpdateInterval) {
                clearInterval(statusUpdateInterval);
                statusUpdateInterval = null;
            }
        }

        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('csvFile');
            const submitBtn = document.getElementById('submitBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const resultDiv = document.getElementById('result');
            const statusContainer = document.getElementById('statusContainer');
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const assistantSelect = document.getElementById('assistantSelect');
            const phoneNumberSelect = document.getElementById('phoneNumberSelect');
            const selectedAssistantId = assistantSelect ? assistantSelect.value : '';
            const selectedPhoneNumberId = phoneNumberSelect ? phoneNumberSelect.value : '';
            
            if (!fileInput.files[0]) {
                resultDiv.innerHTML = '<div class="error">Please select a CSV file.</div>';
                return;
            }
            
            if (!updateTimeInfo()) {
                resultDiv.innerHTML = '<div class="error">Please set a valid time window.</div>';
                return;
            }

            if (!selectedAssistantId) {
                resultDiv.innerHTML = '<div class="error">Please choose which AI assistant should handle this campaign.</div>';
                if (assistantSelect) assistantSelect.focus();
                return;
            }

            if (!selectedPhoneNumberId) {
                resultDiv.innerHTML = '<div class="error">Please pick the phone number callers should see.</div>';
                if (phoneNumberSelect) phoneNumberSelect.focus();
                return;
            }
            
            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            resultDiv.innerHTML = '<div>Uploading file and scheduling calls...</div>';
            
            // Create FormData and upload
            const formData = new FormData();
            formData.append('csvFile', fileInput.files[0]);
            formData.append('startTime', startTime);
            formData.append('endTime', endTime);
            formData.append('assistantId', selectedAssistantId);
            formData.append('phoneNumberId', selectedPhoneNumberId);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <strong>${result.message}</strong><br>
                            Scheduled ${result.totalContacts} calls between ${startTime} and ${endTime}<br>
                            Calling window: ${result.windowHours} hours, ${result.intervalMinutes} minutes between calls<br>
                            Assistant: ${result.assistant ? result.assistant.name : 'Unknown'}<br>
                            Caller ID: ${result.phoneNumber ? (result.phoneNumber.displayName || result.phoneNumber.phoneNumber) : 'Unknown'}<br>
                            Campaign ID: ${result.campaignId}
                        </div>
                    `;
                    
                    // Update selected campaign to the new one
                    selectedCampaignId = result.campaignId;
                    
                    // Reload campaigns to include the new one
                    await loadCampaigns();
                    
                    // Set the dropdown to the new campaign
                    const selector = document.getElementById('campaignSelector');
                    if (selector) {
                        selector.value = result.campaignId;
                        updateCampaignInfo(result.campaignId);
                    }
                    
                    // Show status container and cancel button
                    statusContainer.style.display = 'block';
                    cancelBtn.style.display = 'inline-block';
                    
                    // Start real-time status updates
                    startStatusUpdates();
                    
                } else {
                    resultDiv.innerHTML = `<div class="error">Error: ${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error uploading file: ${error.message}</div>`;
            }
            
            // Re-enable button
            submitBtn.disabled = false;
            submitBtn.textContent = 'Upload and Schedule Calls';
        });
        
        // Cancel calls functionality
        document.getElementById('cancelBtn').addEventListener('click', async function() {
            const cancelBtn = document.getElementById('cancelBtn');
            const resultDiv = document.getElementById('result');
            
            cancelBtn.disabled = true;
            cancelBtn.textContent = 'Cancelling...';
            
            try {
                const response = await fetch('/cancel-calls', { method: 'POST' });
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div class="info">${result.message}</div>`;
                    cancelBtn.style.display = 'none';
                    stopStatusUpdates();
                } else {
                    resultDiv.innerHTML = `<div class="error">Error: ${result.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error cancelling calls: ${error.message}</div>`;
            }
            
            cancelBtn.disabled = false;
            cancelBtn.textContent = 'Cancel All Calls';
        });

        function filterByStatus(filter) {
            currentStatusFilter = filter;
            
            document.querySelectorAll('.status-filter-btn').forEach(btn => btn.classList.remove('active'));
            const targetButton = document.getElementById(`status-filter-${filter}`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            applyFilters();
        }
        
        function filterByOutcome(filter) {
            currentOutcomeFilter = filter;
            
            document.querySelectorAll('.outcome-filter-btn').forEach(btn => btn.classList.remove('active'));
            const targetButton = document.getElementById(`outcome-filter-${filter}`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            applyFilters();
        }
        
        function applyFilters() {
            const rows = document.querySelectorAll('#callsTableBody tr');
            const searchQuery = currentSearchQuery.toLowerCase().trim();
            
            rows.forEach(row => {
                const statusValue = row.dataset.status || 'unknown';
                const outcomeValue = row.dataset.outcome || 'unknown';
                
                const statusMatches = currentStatusFilter === 'all' || statusValue === currentStatusFilter;
                const outcomeMatches = currentOutcomeFilter === 'all' || outcomeValue === currentOutcomeFilter;
                
                // Search filter: check name and phone using data attributes (more efficient)
                let searchMatches = true;
                if (searchQuery) {
                    const contactName = row.dataset.contactName || '';
                    const contactPhone = row.dataset.contactPhone || '';
                    
                    // Check if search query matches name or phone (case-insensitive)
                    const nameMatch = contactName.includes(searchQuery);
                    const phoneMatch = contactPhone.includes(searchQuery);
                    
                    searchMatches = nameMatch || phoneMatch;
                }
                
                row.style.display = statusMatches && outcomeMatches && searchMatches ? '' : 'none';
            });
        }

        async function openAnalyticsPanel() {
            const overlay = document.getElementById('analyticsOverlay');
            const panel = document.getElementById('analyticsPanel');
            const loading = document.getElementById('analyticsLoading');
            const emptyState = document.getElementById('analyticsEmpty');
            const body = document.getElementById('analyticsBody');

            overlay.classList.add('open');
            panel.classList.add('open');

            loading.style.display = 'block';
            emptyState.style.display = 'none';
            body.style.display = 'none';

            const campaignId = selectedCampaignId;
            if (!campaignId) {
                loading.style.display = 'none';
                emptyState.style.display = 'block';
                emptyState.textContent = 'Select a campaign to view analytics.';
                return;
            }

            try {
                const response = await fetch(`/analytics?campaignId=${encodeURIComponent(campaignId)}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch analytics');
                }
                const data = await response.json();

                loading.style.display = 'none';

                if (!data || data.totals.total === 0) {
                    emptyState.style.display = 'block';
                    emptyState.textContent = 'No calls have been completed for this campaign yet.';
                    return;
                }

                emptyState.style.display = 'none';
                body.style.display = 'block';

                populateAnalytics(data);
            } catch (error) {
                console.error('Error loading analytics:', error);
                loading.style.display = 'none';
                emptyState.style.display = 'block';
                emptyState.textContent = 'Unable to load analytics right now. Please try again.';
            }
        }

        function closeAnalyticsPanel() {
            document.getElementById('analyticsOverlay').classList.remove('open');
            document.getElementById('analyticsPanel').classList.remove('open');
        }

        function populateAnalytics(data) {
            const totals = data.totals;
            const answeredPct = totals.total ? Math.round((totals.answered / totals.total) * 100) : 0;
            const voicemailPct = totals.total ? Math.round((totals.voicemail / totals.total) * 100) : 0;

            document.getElementById('analyticsTotal').textContent = totals.total;
            document.getElementById('analyticsAnswered').textContent = totals.answered;
            document.getElementById('analyticsVoicemail').textContent = totals.voicemail;
            document.getElementById('analyticsRetries').textContent = totals.retries;

            document.getElementById('analyticsAnsweredSub').textContent = `${answeredPct}% of total`;
            document.getElementById('analyticsVoicemailSub').textContent = `${voicemailPct}% of total`;
            document.getElementById('analyticsTotalSub').textContent = `Calls placed in this campaign`;
            document.getElementById('analyticsRetriesSub').textContent = totals.retries > 0 ? `${totals.retries} voicemail follow-ups` : 'No retries needed';

            renderAnswerChart(totals);
            renderOutcomeChart(data.outcomes);
            renderOutcomeTable(data.outcomes, totals.answered);
        }

        function renderAnswerChart(totals) {
            const ctx = document.getElementById('analyticsAnswerChart').getContext('2d');
            if (analyticsAnswerChart) {
                analyticsAnswerChart.destroy();
            }
            analyticsAnswerChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Answered', 'Voicemail/Unanswered'],
                    datasets: [{
                        data: [totals.answered, totals.voicemail],
                        backgroundColor: ['#28a745', '#ffc107'],
                        borderColor: ['#28a745', '#ffc107'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderOutcomeChart(outcomes) {
            const ctx = document.getElementById('analyticsOutcomeChart').getContext('2d');
            if (analyticsOutcomeChart) {
                analyticsOutcomeChart.destroy();
            }
            const labels = outcomes.map(o => formatOutcomeLabel(o.outcome));
            const counts = outcomes.map(o => o.count);
            const colors = ['#007cba', '#28a745', '#ffc107', '#17a2b8', '#6f42c1', '#dc3545', '#6c757d'];

            analyticsOutcomeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Calls',
                        data: counts,
                        backgroundColor: labels.map((_, idx) => colors[idx % colors.length])
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderOutcomeTable(outcomes, totalAnswered) {
            const container = document.getElementById('analyticsOutcomeTable');
            if (!outcomes || outcomes.length === 0 || totalAnswered === 0) {
                container.innerHTML = '<div class="analytics-empty">No answered calls yet.</div>';
                return;
            }
            let html = `
                <table style="width:100%; border-collapse: collapse; margin-top: 10px; font-size: 13px;">
                    <thead>
                        <tr style="background:#f0f4f8;">
                            <th style="text-align:left; padding:8px; border:1px solid #dbe1ea;">Outcome</th>
                            <th style="text-align:right; padding:8px; border:1px solid #dbe1ea;">Count</th>
                            <th style="text-align:right; padding:8px; border:1px solid #dbe1ea;">% of answered</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            outcomes.forEach(o => {
                const pct = totalAnswered ? ((o.count / totalAnswered) * 100).toFixed(1) : '0.0';
                html += `
                    <tr>
                        <td style="padding:8px; border:1px solid #eef2f7;">${formatOutcomeLabel(o.outcome)}</td>
                        <td style="padding:8px; border:1px solid #eef2f7; text-align:right;">${o.count}</td>
                        <td style="padding:8px; border:1px solid #eef2f7; text-align:right;">${pct}%</td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Toggle summary display by ID (supports both index and callId)
        function toggleSummaryById(summaryId) {
            const shortDiv = document.getElementById(`summary-short-${summaryId}`);
            const expandedDiv = document.getElementById(`summary-expanded-${summaryId}`);
            
            if (!shortDiv || !expandedDiv) {
                console.error('Summary elements not found for ID:', summaryId);
                return;
            }
            
            if (shortDiv.style.display === 'none') {
                // Collapsing - hide expanded, show short
                shortDiv.style.display = 'block';
                expandedDiv.style.display = 'none';
                // Remove from expanded states
                if (typeof window.expandedStates !== 'undefined') {
                    delete window.expandedStates[summaryId];
                }
            } else {
                // Expanding - hide short, show expanded
                shortDiv.style.display = 'none';
                expandedDiv.style.display = 'block';
                // Add to expanded states
                if (typeof window.expandedStates === 'undefined') {
                    window.expandedStates = {};
                }
                window.expandedStates[summaryId] = true;
            }
        }

        // Legacy function for backward compatibility
        function toggleSummary(index) {
            toggleSummaryById(index);
        }

        // Add Lead Modal Functions
        function openAddLeadModal() {
            const campaignId = selectedCampaignId || null;
            if (!campaignId) {
                alert('Please select a campaign first or upload a CSV to create a campaign.');
                return;
            }
            document.getElementById('addLeadOverlay').style.display = 'block';
            document.getElementById('addLeadModal').style.display = 'block';
            document.getElementById('leadName').focus();
        }

        function closeAddLeadModal() {
            document.getElementById('addLeadOverlay').style.display = 'none';
            document.getElementById('addLeadModal').style.display = 'none';
            document.getElementById('addLeadForm').reset();
        }

        async function handleAddLead(event) {
            event.preventDefault();
            const formData = {
                name: document.getElementById('leadName').value.trim(),
                phone: document.getElementById('leadPhone').value.trim(),
                address: document.getElementById('leadAddress').value.trim(),
                campaignId: selectedCampaignId
            };

            if (!formData.name || !formData.phone) {
                alert('Name and phone are required.');
                return;
            }

            try {
                const response = await fetch('/api/add-lead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    closeAddLeadModal();
                    // Refresh the call status to show the new lead
                    updateCallStatus();
                    alert('Lead added successfully!');
                } else {
                    alert(data.error || 'Error adding lead');
                }
            } catch (error) {
                console.error('Error adding lead:', error);
                alert('Error adding lead. Please try again.');
            }
        }

        // Call a specific lead
        async function callLead(dbCallId) {
            if (!dbCallId) {
                alert('Invalid call ID');
                return;
            }

            if (!confirm('Initiate call for this lead?')) {
                return;
            }

            try {
                const response = await fetch('/api/call-lead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ dbCallId })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Refresh status to show updated call state
                    updateCallStatus();
                } else {
                    alert(data.error || 'Error initiating call');
                }
            } catch (error) {
                console.error('Error calling lead:', error);
                alert('Error initiating call. Please try again.');
            }
        }

        // Retry single call
        async function retrySingleCall(dbCallId) {
            if (!dbCallId) {
                alert('Invalid call ID');
                return;
            }

            await retrySelectedCalls([dbCallId]);
        }

        // Add to CRM
        async function addToCRM(dbCallId) {
            if (!dbCallId) {
                alert('Invalid contact ID');
                return;
            }

            // Check if already successfully added (status 200)
            if (addedToCRM.has(dbCallId)) {
                return; // Already added successfully, do nothing
            }

            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Sending...';

            try {
                const response = await fetch('/api/admin/send-to-webhook', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ contactId: dbCallId })
                });

                const data = await response.json();

                // Check if webhook returned status 200
                if (response.ok && data.success && data.status === 200) {
                    // Success - mark as added and remove from failed list
                    addedToCRM.add(dbCallId);
                    failedCRM.delete(dbCallId);
                    
                    // Update button to "Added" state permanently
                    button.textContent = 'âœ“ Added';
                    button.style.background = '#6c757d';
                    button.style.cursor = 'not-allowed';
                    button.onclick = null; // Remove onclick handler
                    button.title = 'Already added to CRM';
                    button.disabled = true;
                } else {
                    // Failed - mark as failed and show "Try Again"
                    failedCRM.add(dbCallId);
                    addedToCRM.delete(dbCallId); // Remove from success list if it was there
                    
                    // Update button to "Try Again" state
                    button.textContent = 'ðŸ”„ Try Again';
                    button.style.background = '#dc3545';
                    button.disabled = false;
                    button.title = 'Click to retry sending to CRM';
                    
                    // Show error message if available
                    const errorMsg = data.error || data.message || `Webhook returned status ${data.status || 'unknown'}`;
                    console.error('Failed to send to CRM:', errorMsg);
                }
            } catch (error) {
                console.error('Error sending to CRM:', error);
                
                // Network error or other exception - mark as failed
                failedCRM.add(dbCallId);
                addedToCRM.delete(dbCallId);
                
                // Update button to "Try Again" state
                button.textContent = 'ðŸ”„ Try Again';
                button.style.background = '#dc3545';
                button.disabled = false;
                button.title = 'Click to retry sending to CRM';
            }
        }

        // Retry selected calls
        async function retrySelectedCalls(dbCallIds = null) {
            // If dbCallIds not provided, get from checkboxes
            if (!dbCallIds) {
                const checkboxes = document.querySelectorAll('.call-checkbox:checked');
                dbCallIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.callId)).filter(id => id);
            }

            if (!dbCallIds || dbCallIds.length === 0) {
                alert('Please select at least one call to retry.');
                return;
            }

            if (!confirm(`Retry ${dbCallIds.length} selected call(s)?`)) {
                return;
            }

            try {
                const response = await fetch('/api/retry-selected', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ dbCallIds })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Clear selections from both DOM and stored state
                    document.querySelectorAll('.call-checkbox:checked').forEach(cb => cb.checked = false);
                    document.getElementById('selectAllCheckbox').checked = false;
                    if (window.selectedCallIds) {
                        window.selectedCallIds.clear();
                    }
                    updateRetryButtonVisibility();
                    
                    // Refresh status to show new retry calls
                    updateCallStatus();
                    
                    alert(data.message || `Retry initiated for ${data.summary.success} call(s).`);
                } else {
                    alert(data.error || 'Error retrying calls');
                }
            } catch (error) {
                console.error('Error retrying calls:', error);
                alert('Error retrying calls. Please try again.');
            }
        }

        // Toggle select all checkboxes
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllCheckbox');
            const checkboxes = document.querySelectorAll('.call-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            updateRetryButtonVisibility();
        }

        // Update retry button visibility based on selected calls
        function updateRetryButtonVisibility() {
            // Initialize selectedCallIds if it doesn't exist
            if (!window.selectedCallIds) {
                window.selectedCallIds = new Set();
            }
            
            // Update the set based on current checkbox states
            const allCheckboxes = document.querySelectorAll('.call-checkbox');
            allCheckboxes.forEach(checkbox => {
                const callId = parseInt(checkbox.dataset.callId);
                if (callId) {
                    if (checkbox.checked) {
                        window.selectedCallIds.add(callId);
                    } else {
                        window.selectedCallIds.delete(callId);
                    }
                }
            });
            
            const checkedBoxes = document.querySelectorAll('.call-checkbox:checked');
            const retryBtn = document.getElementById('retrySelectedBtn');
            if (checkedBoxes.length > 0) {
                retryBtn.style.display = 'inline-flex';
            } else {
                retryBtn.style.display = 'none';
            }
        }

        // Sidebar Toggle Functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const dashboardLayout = document.querySelector('.dashboard-layout');
            const isCollapsed = sidebar.classList.contains('sidebar-collapsed');
            
            if (isCollapsed) {
                // Expand sidebar
                sidebar.classList.remove('sidebar-collapsed');
                dashboardLayout.classList.remove('sidebar-collapsed');
                localStorage.setItem('sidebarCollapsed', 'false');
            } else {
                // Collapse sidebar
                sidebar.classList.add('sidebar-collapsed');
                dashboardLayout.classList.add('sidebar-collapsed');
                localStorage.setItem('sidebarCollapsed', 'true');
            }
        }

        // Initialize sidebar state from localStorage
        function initializeSidebar() {
            const sidebarCollapsed = localStorage.getItem('sidebarCollapsed');
            const sidebar = document.getElementById('sidebar');
            const dashboardLayout = document.querySelector('.dashboard-layout');
            
            if (sidebarCollapsed === 'true') {
                sidebar.classList.add('sidebar-collapsed');
                dashboardLayout.classList.add('sidebar-collapsed');
            } else {
                sidebar.classList.remove('sidebar-collapsed');
                dashboardLayout.classList.remove('sidebar-collapsed');
            }
        }

        // Initialize sidebar on page load (run immediately if DOM already loaded, otherwise wait)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeSidebar);
        } else {
            // DOM is already ready
            initializeSidebar();
        }

        // Also allow clicking sidebar header to expand when collapsed
        function setupSidebarHeaderClick() {
            const sidebarHeader = document.querySelector('.sidebar-header');
            if (sidebarHeader) {
                sidebarHeader.addEventListener('click', function(e) {
                    // Don't trigger if clicking the toggle button
                    if (e.target.closest('.sidebar-toggle')) {
                        return;
                    }
                    // Only expand if collapsed
                    const sidebar = document.getElementById('sidebar');
                    if (sidebar && sidebar.classList.contains('sidebar-collapsed')) {
                        toggleSidebar();
                    }
                });
            }
        }

        // Setup sidebar header click handler
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupSidebarHeaderClick);
        } else {
            setupSidebarHeaderClick();
        }

// Edit name functionality
function editName(index) {
    const displaySpan = document.getElementById(`name-display-${index}`);
    const editInput = document.getElementById(`name-edit-${index}`);
    
    displaySpan.style.display = 'none';
    editInput.style.display = 'inline-block';
    editInput.focus();
    editInput.select();
}

function saveName(index) {
    const displaySpan = document.getElementById(`name-display-${index}`);
    const editInput = document.getElementById(`name-edit-${index}`);
    
    const newName = editInput.value.trim();
    if (newName) {
        displaySpan.textContent = newName;
        // TODO: Update database with new name
        updateContactInDatabase(index, 'name', newName);
    }
    
    displaySpan.style.display = 'inline';
    editInput.style.display = 'none';
}

// Edit phone functionality
function editPhone(index) {
    const displaySpan = document.getElementById(`phone-display-${index}`);
    const editInput = document.getElementById(`phone-edit-${index}`);
    
    displaySpan.style.display = 'none';
    editInput.style.display = 'inline-block';
    editInput.focus();
    editInput.select();
}

function savePhone(index) {
    const displaySpan = document.getElementById(`phone-display-${index}`);
    const editInput = document.getElementById(`phone-edit-${index}`);
    
    const newPhone = editInput.value.trim();
    if (newPhone) {
        displaySpan.textContent = newPhone;
        // TODO: Update database with new phone
        updateContactInDatabase(index, 'phone', newPhone);
    }
    
    displaySpan.style.display = 'inline';
    editInput.style.display = 'none';
}

// Update contact in database
async function updateContactInDatabase(index, field, value) {
    try {
        const response = await fetch('/update-contact', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                index: index,
                field: field,
                value: value
            })
        });
        
        if (!response.ok) {
            console.error('Failed to update contact in database');
        }
    } catch (error) {
        console.error('Error updating contact:', error);
    }
}

        // ============================================
        // Campaign Management Functions
        // ============================================

        let campaignToDelete = null;

        // Open campaign management modal
        async function openCampaignManagementModal() {
            const modal = document.getElementById('campaignManagementModal');
            const loading = document.getElementById('campaignManagementLoading');
            const content = document.getElementById('campaignManagementContent');
            const noCampaigns = document.getElementById('noCampaignsMessage');

            modal.style.display = 'flex';
            loading.style.display = 'block';
            content.style.display = 'none';
            noCampaigns.style.display = 'none';

            try {
                const campaigns = await loadCampaigns();
                loading.style.display = 'none';

                if (campaigns && campaigns.length > 0) {
                    content.style.display = 'block';
                    populateCampaignsTable(campaigns);
                } else {
                    noCampaigns.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading campaigns:', error);
                loading.style.display = 'none';
                showToast('Error loading campaigns', 'error');
            }
        }

        // Close campaign management modal
        function closeCampaignManagementModal() {
            const modal = document.getElementById('campaignManagementModal');
            modal.style.display = 'none';
        }

        // Populate campaigns table
        function populateCampaignsTable(campaigns) {
            const tbody = document.getElementById('campaignsTableBody');
            tbody.innerHTML = '';

            campaigns.forEach(campaign => {
                const row = document.createElement('tr');
                
                // Format date
                let dateStr = 'Date unknown';
                if (campaign.createdAt) {
                    const date = new Date(campaign.createdAt);
                    if (!isNaN(date.getTime())) {
                        dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    }
                }

                // Determine status
                const totalCalls = campaign.callCount || 0;
                const completedCalls = campaign.completedCount || 0;
                let statusClass = 'inactive';
                let statusText = 'Inactive';
                
                if (totalCalls > 0) {
                    if (completedCalls === totalCalls) {
                        statusClass = 'completed';
                        statusText = 'Completed';
                    } else {
                        statusClass = 'active';
                        statusText = 'Active';
                    }
                }

                // Campaign name (using campaignId with assistant/phone info)
                const campaignName = campaign.campaignId || 'Unknown';
                const assistantLabel = campaign.assistantName || 'Not set';
                const phoneLabel = campaign.phoneNumberName || 'Not set';

                // Escape HTML to prevent XSS
                const escapeHtml = (text) => {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                };

                const escapedCampaignName = escapeHtml(campaignName);
                const escapedAssistantLabel = escapeHtml(assistantLabel);
                const escapedPhoneLabel = escapeHtml(phoneLabel);
                const escapedCampaignId = escapeHtml(campaign.campaignId);

                row.innerHTML = `
                    <td>
                        <div class="campaign-name">${escapedCampaignName}</div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                            ${escapedAssistantLabel} â€¢ ${escapedPhoneLabel}
                        </div>
                    </td>
                    <td>${escapeHtml(dateStr)}</td>
                    <td>${totalCalls}</td>
                    <td>${completedCalls}</td>
                    <td><span class="campaign-status ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn-delete-campaign" onclick="initiateDeleteCampaign('${escapedCampaignId.replace(/'/g, "\\'")}', '${escapedCampaignName.replace(/'/g, "\\'")}', ${totalCalls})">
                            Delete
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Initiate delete campaign (opens confirmation modal)
        function initiateDeleteCampaign(campaignId, campaignName, callCount) {
            campaignToDelete = campaignId;
            const modal = document.getElementById('deleteCampaignModal');
            const warningText = document.getElementById('deleteWarningText');
            const confirmInput = document.getElementById('deleteConfirmInput');
            const confirmBtn = document.getElementById('confirmDeleteBtn');

            warningText.textContent = `Are you sure? This will permanently delete "${campaignName}" and all ${callCount} associated calls. This cannot be undone.`;
            confirmInput.value = '';
            confirmBtn.disabled = true;

            // Enable/disable delete button based on input
            confirmInput.oninput = function() {
                confirmBtn.disabled = confirmInput.value.trim() !== 'DELETE';
            };

            modal.style.display = 'flex';
            confirmInput.focus();
        }

        // Close delete confirmation modal
        function closeDeleteCampaignModal() {
            const modal = document.getElementById('deleteCampaignModal');
            modal.style.display = 'none';
            campaignToDelete = null;
            document.getElementById('deleteConfirmInput').value = '';
        }

        // Confirm and execute campaign deletion
        async function confirmDeleteCampaign() {
            if (!campaignToDelete) {
                showToast('No campaign selected for deletion', 'error');
                return;
            }

            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const confirmInput = document.getElementById('deleteConfirmInput');

            if (confirmInput.value.trim() !== 'DELETE') {
                showToast('Please type "DELETE" to confirm', 'error');
                return;
            }

            // Disable button during deletion
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Deleting...';

            try {
                const response = await fetch(`/api/campaigns/${campaignToDelete}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast(`Campaign "${campaignToDelete}" deleted successfully`, 'success');
                    closeDeleteCampaignModal();

                    // Reload campaigns and update UI
                    const campaigns = await loadCampaigns();
                    
                    // Check if deleted campaign was the currently selected one
                    if (selectedCampaignId === campaignToDelete) {
                        // Select the most recent campaign or clear selection
                        if (campaigns && campaigns.length > 0) {
                            selectedCampaignId = campaigns[0].campaignId;
                            const selector = document.getElementById('campaignSelector');
                            if (selector) {
                                selector.value = selectedCampaignId;
                                updateCampaignInfo(selectedCampaignId);
                            }
                            updateCallStatus();
                        } else {
                            selectedCampaignId = null;
                            const selector = document.getElementById('campaignSelector');
                            if (selector) {
                                selector.value = '';
                            }
                            document.getElementById('campaignInfo').innerHTML = '';
                        }
                    }

                    // Refresh the campaigns table if modal is open
                    const managementModal = document.getElementById('campaignManagementModal');
                    if (managementModal.style.display === 'flex') {
                        await openCampaignManagementModal();
                    }
                } else {
                    throw new Error(data.error || 'Failed to delete campaign');
                }
            } catch (error) {
                console.error('Error deleting campaign:', error);
                showToast(error.message || 'Error deleting campaign', 'error');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Delete Campaign';
            }
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸'
            };

            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;

            container.appendChild(toast);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideInRight 0.3s ease reverse';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const campaignModal = document.getElementById('campaignManagementModal');
            const deleteModal = document.getElementById('deleteCampaignModal');
            
            if (event.target === campaignModal) {
                closeCampaignManagementModal();
            }
            if (event.target === deleteModal) {
                closeDeleteCampaignModal();
            }
        }

        // Handle Escape key to close modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const campaignModal = document.getElementById('campaignManagementModal');
                const deleteModal = document.getElementById('deleteCampaignModal');
                
                if (campaignModal.style.display === 'flex') {
                    closeCampaignManagementModal();
                }
                if (deleteModal.style.display === 'flex') {
                    closeDeleteCampaignModal();
                }
            }
        });
    </script>

    <!-- Campaign Management Modal -->
    <div id="campaignManagementModal" class="modal-overlay" style="display: none;">
        <div class="modal-content campaign-modal">
            <div class="modal-header">
                <h2>ðŸ“‹ Campaign Management</h2>
                <button class="modal-close" onclick="closeCampaignManagementModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="campaignManagementLoading" class="loading-state" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading campaigns...</p>
                </div>
                <div id="campaignManagementContent" style="display: none;">
                    <div id="campaignsTableContainer">
                        <table class="campaigns-table">
                            <thead>
                                <tr>
                                    <th>Campaign Name</th>
                                    <th>Created Date</th>
                                    <th>Total Calls</th>
                                    <th>Completed</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="campaignsTableBody">
                                <!-- Campaigns will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="noCampaignsMessage" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
                        <p>No campaigns found.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteCampaignModal" class="modal-overlay" style="display: none;">
        <div class="modal-content delete-confirm-modal">
            <div class="modal-header">
                <h2>âš ï¸ Delete Campaign</h2>
                <button class="modal-close" onclick="closeDeleteCampaignModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="delete-warning" id="deleteWarningText"></p>
                <div class="delete-confirm-input">
                    <label for="deleteConfirmInput">Type <strong>"DELETE"</strong> to confirm:</label>
                    <input type="text" id="deleteConfirmInput" placeholder="Type DELETE here" autocomplete="off">
                </div>
                <div class="modal-actions">
                    <button class="btn-cancel" onclick="closeDeleteCampaignModal()">Cancel</button>
                    <button class="btn-delete" id="confirmDeleteBtn" onclick="confirmDeleteCampaign()" disabled>Delete Campaign</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="toast-container"></div>
    </div>
</body>
</html>